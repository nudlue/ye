<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹¤ì‹œê°„ ì†Œë¦¬ ë¶„ë¥˜ê¸°</title>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0"></script>

  <!-- Teachable Machine Sound -->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/sound@0.8/dist/teachablemachine-sound.min.js"></script>

  <style>
    body { font-family: sans-serif; text-align: center; padding: 40px; }
    button {
      padding: 12px 24px; 
      font-size: 20px;
      cursor: pointer;
      margin: 10px;
    }
    #result { margin-top: 30px; font-size: 30px; }
    #emoji { font-size: 80px; margin-top: 10px; }
  </style>

</head>

<body>

  <h1>ğŸ”Š ì‹¤ì‹œê°„ ì†Œë¦¬ ë¶„ë¥˜ê¸°</h1>

  <button id="startBtn">ë…¹ìŒ ì‹œì‘</button>
  <button id="stopBtn">ë…¹ìŒ ì¢…ë£Œ</button>

  <div id="result">ëŒ€ê¸° ì¤‘...</div>
  <div id="emoji">ğŸ˜¶</div>

  <script>
    // ëª¨ë¸ íŒŒì¼ì€ index.htmlê³¼ ê°™ì€ í´ë”ì— ë‘ 
    const URL = "./";
    let model, mic, isListening = false;
    let loopId;

    const emojis = {
      "Baby Crying": "ğŸ‘¶ğŸ˜­",
      "Doorbell": "ğŸšªğŸ””",
      "Fire Alarm": "ğŸ”¥ğŸš¨",
      "ë°°ê²½ ì†ŒìŒ": "ğŸŒ«ï¸",
    };

    // 1) ëª¨ë¸ ë¡œë“œ
    async function loadModel() {
      model = await tmSound.create(
        URL + "model.json",
        URL + "metadata.json"
      );
      console.log("TM ëª¨ë¸ ë¡œë“œ ì™„ë£Œ");
    }
    loadModel();

    // 2) ë…¹ìŒ ì‹œì‘
    async function startRecording() {
      if (isListening) return;
      isListening = true;

      mic = new tmSound.Microphone();
      await mic.open();   // ë§ˆì´í¬ ì ‘ê·¼
      console.log("ë§ˆì´í¬ ì—°ê²°ë¨");

      loop();
    }

    // 3) ë…¹ìŒ ì¢…ë£Œ
    function stopRecording() {
      if (!isListening) return;
      isListening = false;

      if (loopId) cancelAnimationFrame(loopId);
      if (mic) mic.close();   // TM ë°©ì‹ì—ì„œëŠ” close()ë§Œ í•´ë„ ë¨

      document.getElementById("result").innerText = "ë…¹ìŒì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
      document.getElementById("emoji").innerText = "ğŸ˜´";
    }

    // 4) ì‹¤ì‹œê°„ ë¶„ë¥˜ loop
    async function loop() {
      if (!isListening) return;

      const prediction = await model.predict(mic);

      // ê°€ì¥ ë†’ì€ ì ìˆ˜ ì°¾ê¸°
      let bestIdx = 0;
      for (let i = 1; i < prediction.length; i++) {
        if (prediction[i].score > prediction[bestIdx].score) {
          bestIdx = i;
        }
      }

      const label = prediction[bestIdx].className;

      document.getElementById("result").innerText = `ì¸ì‹ ê²°ê³¼: ${label}`;
      document.getElementById("emoji").innerText = emojis[label] || "ğŸ§";

      loopId = requestAnimationFrame(loop);
    }

    document.getElementById("startBtn").onclick = startRecording;
    document.getElementById("stopBtn").onclick = stopRecording;

  </script>
</body>
</html>
